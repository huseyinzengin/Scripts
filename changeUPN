Bu dokÃ¼man, Microsoft Graph API ve PowerShell kullanÄ±larak Microsoft 365 kullanÄ±cÄ±larÄ±nÄ±n User Principal Name (UPN) deÄŸerlerinin belirli bir kuruma ait alan adÄ±na gÃ¶re otomatik gÃ¼ncellenmesini saÄŸlayan sÃ¼reci aÃ§Ä±klamaktadÄ±r.

1ï¸âƒ£ PowerShell Gereksinimleri
Ä°ÅŸlem yapÄ±lacak makinede aÅŸaÄŸÄ±daki PowerShell modÃ¼lÃ¼nÃ¼n kurulu olmasÄ± gerekir:

Microsoft.Graph PowerShell SDK YÃ¼klemesi
Install-Module Microsoft.Graph -Scope CurrentUser

âš ï¸ Not: Makinede eski Microsoft Graph modÃ¼lleri varsa kaldÄ±rÄ±lmalÄ± ya da -Force parametresi kullanÄ±lmalÄ±dÄ±r.



2ï¸âƒ£ Azure App Registration Ä°ÅŸlemi

Microsoft Graph API ile PowerShell Ã¼zerinden iÅŸlem yapabilmek iÃ§in Azure AD'de bir uygulama kaydÄ± yapÄ±lmalÄ± ve uygun izinler verilmelidir.

ğŸ“Œ AdÄ±mlar:
Azure portalÄ±na giriÅŸ yapÄ±n: https://portal.azure.com

Azure Active Directory > App registrations > New registration adÄ±mlarÄ±nÄ± izleyin.

Bir uygulama adÄ± verin (Ã¶rneÄŸin: OZU-ChangeUPNScript) ve Single tenant olarak bÄ±rakÄ±n.

Uygulama oluÅŸturulduktan sonra:

Application (client) ID bilgisini not edin

Directory (tenant) ID: bilgisini not edin

Client Secret bilgilerini not edin.

API permissions > Add a permission > Microsoft Graph > Application permissions bÃ¶lÃ¼mÃ¼nden aÅŸaÄŸÄ±daki izinleri ekleyin:

User.Read.All
User.ReadWrite.All

Ä°zinleri ekledikten sonra "Grant admin consent" iÅŸlemini gerÃ§ekleÅŸtirin.

3ï¸âƒ£ PowerShell Script'in YapÄ±sÄ±
Script aÅŸaÄŸÄ±daki iÅŸlemleri gerÃ§ekleÅŸtirmektedir:

Kurum alan adÄ±yla biten UPN'leri filtreler.  (universityname.onmicrosoft.com)

KullanÄ±cÄ±nÄ±n ProxyAddresses deÄŸerinde uygun SMTP adresi varsa, bu adresi yeni UPN olarak belirler.

exceptionList iÃ§inde olan kullanÄ±cÄ±lar iÅŸlem dÄ±ÅŸÄ±nda bÄ±rakÄ±lÄ±r.

UPN deÄŸiÅŸikliÄŸi gerekiyorsa Update-MgUser ile gÃ¼ncelleme yapÄ±lÄ±r.

GÃ¼ncelleme Ã¶ncesi ve sonrasÄ± CSV kayÄ±tlarÄ± alÄ±nÄ±r. (C:\scripts\output altÄ±na yedeklenir)

EÄŸer en az bir kullanÄ±cÄ± gÃ¼ncellendiyse, HTML formatÄ±nda Ã¶zet iÃ§eren bir e-posta gÃ¶nderilir.

ğŸ’» Scriptâ€™in TamamÄ±
# BaÄŸlantÄ± iÃ§in gerekli kimlik bilgileri
$TenantId = "daha Ã¶nce not ettiÄŸimiz bilgiyi ekleyin"
$ClientId = "daha Ã¶nce not ettiÄŸimiz bilgiyi ekleyin"
$ClientSecret = "daha Ã¶nce not ettiÄŸimiz bilgiyi ekleyin"
$SecureClientSecret = ConvertTo-SecureString $ClientSecret -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential($ClientId, $SecureClientSecret)

Connect-MgGraph -TenantId $TenantId -ClientSecretCredential $Cred

# KlasÃ¶r ve dosya isimleri
$OutputFolder = "C:\scripts\output\"
$CurrentDate = Get-Date -Format 'yyyy-MM-dd_HH-mm'
$BeforeCsv = "$OutputFolder\Users_BeforeUpdate_$CurrentDate.csv"
$AfterCsv  = "$OutputFolder\Users_AfterUpdate_$CurrentDate.csv"

# Eski CSV'leri temizle
Get-ChildItem -Path $OutputFolder -Filter "*.csv" | Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-15) } | Remove-Item -Force

# Ä°stisna kullanÄ±cÄ±lar (kÃ¼Ã§Ã¼k harfle yazÄ±lmalÄ±)
$exceptionList = @(
    "azureadmin@universityname.onmicrosoft.com",
    "other.user@universityname.onmicrosoft.com"
)

# KullanÄ±cÄ±larÄ± getir
$users = Get-MgUser -All -Property "DisplayName,UserPrincipalName,Id,ProxyAddresses,Mail"

# Yerel filtreleme
$filteredUsers = $users | Where-Object { $_.UserPrincipalName -like "*@universityname.onmicrosoft.com" }

# Ã–ncesi CSV
$filteredUsers | Select-Object DisplayName, UserPrincipalName, Mail, Id, @{Name="ProxyAddresses";Expression={($_.ProxyAddresses -join ";")}} | Export-Csv -Path $BeforeCsv -NoTypeInformation

# HTML tablo baÅŸlat
$htmlTable = @"
<style>
table { border-collapse: collapse; width: 100%; font-family: Arial; }
th, td { border: 1px solid #ccc; padding: 8px; }
th { background-color: #f2f2f2; }
</style>
<h2>UPN GÃ¼ncelleme Raporu - $CurrentDate</h2>
<table>
<tr>
    <th>Display Name</th>
    <th>Eski UPN</th>
    <th>Yeni UPN</th>
    <th>Durum</th>
</tr>
"@

# GÃ¼ncelleme yapÄ±lmÄ±ÅŸ kullanÄ±cÄ± sayÄ±sÄ±
$updateCount = 0

foreach ($user in $filteredUsers) {
    $upn = $user.UserPrincipalName.ToLower()
    if ($exceptionList -contains $upn -or $upn -like "*#ext#@*") {
        continue
    }

    $newUPN = $user.ProxyAddresses |
        Where-Object { $_ -match "^smtp:.*@(universityname\.edu\.tr|otherdomain\.edu\.tr)$" } |
        ForEach-Object { $_.ToLower().Replace("smtp:", "") } |
        Select-Object -First 1

    if (-not $newUPN) {
        $status = "â“ Proxy uygun deÄŸil"
    }
    elseif ($newUPN -ne $upn) {
        try {
            Update-MgUser -UserId $user.Id -UserPrincipalName $newUPN -ErrorAction Stop
            $status = "ğŸ”„ GÃ¼ncellendi"
            $updateCount++
        } catch {
            $status = "âŒ HATA: $_"
        }
    } else {
        $status = "âœ… Zaten uygun"
    }

    $htmlTable += "<tr><td>$($user.DisplayName)</td><td>$upn</td><td>$newUPN</td><td>$status</td></tr>"
}

$htmlTable += "</table>"

# SonrasÄ± CSV
$filteredUsers = Get-MgUser -All -Property "DisplayName,UserPrincipalName,Id,ProxyAddresses,Mail"
$filteredUsers | Select-Object DisplayName, UserPrincipalName, Mail, Id, @{Name="ProxyAddresses";Expression={($_.ProxyAddresses -join ";")}} | Export-Csv -Path $AfterCsv -NoTypeInformation

# E-posta gÃ¶nderimi (sadece gÃ¼ncelleme yapÄ±lmÄ±ÅŸsa)
if ($updateCount -gt 0) {
    $To = 'sysadmins@universityname.edu.tr'
    $From = 'automation@universityname.edu.tr'
    $Subject = "UPN GÃ¼ncellemeleri: $CurrentDate"
    $SmtpServer = "10.100.10.10"
    $Port = 25

    Send-MailMessage -To $To -From $From -Subject $Subject -Body $htmlTable -SmtpServer $SmtpServer -Port $Port -BodyAsHtml -Encoding ([System.Text.Encoding]::UTF8)
} else {
    Write-Host "GÃ¼ncelleme yapÄ±lmadÄ±, e-posta gÃ¶nderilmeyecek."
}

4ï¸âƒ£ KullanÄ±m NotlarÄ±

Script otomatik olarak sadece @universityname.onmicrosoft.com uzantÄ±lÄ± UPNâ€™leri kontrol eder.

ProxyAddresses alanÄ± iÃ§inde smtp:xxx@university.edu.tr ya da smtp:xxx@universite.edu.tr adresi varsa, bu adres yeni UPN olarak atanÄ±r.

E-posta gÃ¶nderimi, sadece en az bir kullanÄ±cÄ± gÃ¼ncellendiyse yapÄ±lÄ±r.

15 gÃ¼nden eski CSV dosyalarÄ± otomatik silinir.

Script zamanlanmÄ±ÅŸ gÃ¶rev (Task Scheduler) ile periyodik Ã§alÄ±ÅŸtÄ±rÄ±labilir.

ğŸ“ Ã–rnek Ã‡Ä±ktÄ±lar
CSV DosyalarÄ±:

Users_BeforeUpdate_yyyy-MM-dd_HH-mm.csv

Users_AfterUpdate_yyyy-MM-dd_HH-mm.csv

E-posta iÃ§eriÄŸi: GÃ¼ncellenen kullanÄ±cÄ±larÄ± listeleyen HTML tablo.

ğŸ§ª Test ve DoÄŸrulama
Script test ortamÄ±nda -WhatIf parametresiyle Ã§alÄ±ÅŸtÄ±rÄ±larak hiÃ§bir kullanÄ±cÄ±ya mÃ¼dahale etmeden Ã§Ä±ktÄ±lar kontrol edilebilir.

Ä°lk kullanÄ±m Ã¶ncesi e-posta gÃ¶nderimi iÃ§in SMTP sunucusunun eriÅŸilebilir olduÄŸundan emin olun.

